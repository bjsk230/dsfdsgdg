<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Admin (Anonymous)</title>
    <script src="https://cdn.socket.io"></script>
    <style>
        body { font-family: sans-serif; background: #e5ddd5; margin: 0; display: flex; height: 100vh; }
        /* Layout container */
        #chat-container { display: flex; flex-direction: column; flex: 1; }
        /* User List Sidebar (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö User ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ) */
        #user-list-sidebar { width: 250px; background: #f7f7f7; padding: 15px; overflow-y: auto; border-right: 1px solid #ccc; display: none; }
        #user-list-sidebar h4 { margin-top: 0; }
        .user-item { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; }
        .user-item:hover { background: #e9e9e9; }
        .user-item.active-target { background: #a8dadc; font-weight: bold; }

        #header { background: #075e54; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 10px; border-radius: 10px; max-width: 85%; box-shadow: 0 1px 1px rgba(0,0,0,0.1); font-size: 14px; line-height: 1.4; }
        .msg.my-msg { background: #dcf8c6; align-self: flex-end; }
        .msg.admin-msg { background: #a8dadc; align-self: flex-start; }
        .msg.other-msg { background: white; align-self: flex-start; }
        .msg.system-msg { background: #fff3cd; color: #856404; text-align: center; font-style: italic; width: 100%; }
        #input-area { background: #f0f0f0; padding: 10px; display: flex; gap: 8px; border-top: 1px solid #ccc; align-items: center; }
        input { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
        button { border: none; background: #075e54; color: white; padding: 10px 18px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .del-btn { background: #d9534f; font-size: 11px; padding: 5px 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <div id="user-list-sidebar">
        <h4>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)</h4>
        <div id="user-list">
            <!-- User items will be injected here by JS -->
        </div>
    </div>
    
    <div id="chat-container">
        <div id="header">
            <span id="my-name">‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: ...</span>
            <button class="del-btn" onclick="clearChat()">‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ù‡∏±‡πà‡∏á‡∏â‡∏±‡∏ô</button>
        </div>
        <div id="chat"></div>
        <div id="input-area">
            <input type="text" id="m" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÉ‡∏ä‡πâ /logout ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)" autocomplete="off">
            <button id="send-btn" onclick="sendMsg()" disabled>‡∏™‡πà‡∏á</button>
        </div>
    </div>

 <script>
    const socket = io();
    let isAdmin = false; 
    let targetSid = null;

    socket.on('connect', () => { socket.emit('join'); });
    socket.on('disconnect', (reason) => { });
    document.getElementById('send-btn').disabled = false;

    socket.on('set_identity', d => { document.getElementById('my-name').innerText = d.name; });
    
    // --- Admin Features ---
    socket.on('admin_status', d => {
        isAdmin = d.is_admin;
        if (isAdmin) {
            document.getElementById('user-list-sidebar').style.display = 'block';
            if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                Notification.requestPermission();
            }
        } else {
            document.getElementById('user-list-sidebar').style.display = 'none';
        }
    });

    // ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å Server ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô Sidebar
    socket.on('update_user_list', d => {
        const userListDiv = document.getElementById('user-list');
        userListDiv.innerHTML = ''; // Clear current list
        d.users.forEach(user => {
            const userItem = document.createElement('div');
            userItem.className = 'user-item';
            userItem.innerText = user.name;
            userItem.onclick = () => setReply(user.sid, user.name);
            userListDiv.appendChild(userItem);
        });
    });

    // Helper functions (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    function playNotificationSound() {
        const audio = new Audio('https://assets.mixkit.co');
        audio.play().catch(e => console.warn("Audio play failed"));
    }
    
    function appendMessage(user, text, className, fromSid = null) {
        const div = document.createElement('div');
        div.className = `msg ${className}`;
        let tool = '';
        if (fromSid && isAdmin) { 
            // ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏Å‡∏î‡∏ó‡∏µ‡πà Sidebar
            tool = `<span class="admin-action" onclick="setReply('${fromSid}', '${user}')">‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ</span>`;
        }
        div.innerHTML = `<b>${user}:</b> ${text}${tool}`;
        document.getElementById('chat').appendChild(div);
        document.getElementById('chat').scrollTop = 99999;
        return div;
    }

    // --- Event Handlers (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    socket.on('new_msg', d => {
        const msgClass = (d.user === "‡∏Ñ‡∏∏‡∏ì") ? 'my-msg' : (d.user === "ADMIN" ? 'admin-msg' : 'other-msg');
        appendMessage(d.user, d.text, msgClass, d.from_sid);
    });

    socket.on('sys_msg', d => {
        if (isAdmin && (d.msg.includes("üì©") || d.msg.includes("üîî"))) {
            playNotificationSound();
            if (Notification.permission === "granted") {
                new Notification("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ä‡∏ó", { body: d.msg, icon: 'https://railway.app' });
            }
        }
        appendMessage("System", d.msg, "system-msg");
    });
    
    socket.on('clear_screen', () => { document.getElementById('chat').innerHTML = "<div class='msg system-msg'>--- ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ù‡∏±‡πà‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß ---</div>"; });

    // --- Action Functions ---

    function sendMsg() {
        const input = document.getElementById('m');
        if(!input.value.trim()) return;
        if(!socket || !socket.connected) {
            alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
            return;
        }
        // ‡πÉ‡∏ä‡πâ targetSid ‡∏à‡∏≤‡∏Å Global variable
        const payload = {text: input.value, target_sid: targetSid}; 
        socket.emit('message', payload);
        input.value = '';
    }
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô setReply ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö targetSid ‡πÅ‡∏•‡∏∞‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô Sidebar
    function setReply(sid, name = 'User') {
        targetSid = sid;
        document.getElementById('m').focus();
        // ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå user ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≠‡∏ö‡πÉ‡∏ô Sidebar (CSS ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö active-target)
        document.querySelectorAll('.user-item').forEach(el => {
            el.classList.remove('active-target');
            if (el.innerText.includes(name)) {
                el.classList.add('active-target');
            }
        });
        appendMessage("System", `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ñ‡∏∂‡∏á ${name}`, "system-msg");
    }

    function clearChat() { if(confirm("‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ù‡∏±‡πà‡∏á‡∏Ñ‡∏∏‡∏ì?")) socket.emit('clear_my_chat'); }

    document.getElementById('m').addEventListener("keypress", (e) => { if (e.key === "Enter") sendMsg(); });
 </script>
</html>
